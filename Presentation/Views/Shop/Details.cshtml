@model Presentation.ViewModels.Shop.ProductDetailViewModel
@{
    ViewData["Title"] = Model.Name;
    var displayPrice = Model.DiscountPrice ?? Model.SalePrice;
}

<div class="container py-4">
    <div class="card glass-card border-0 shadow-sm overflow-hidden">
        <div class="row g-0">
            <div class="col-md-5 p-4 position-relative">
                <div class="position-absolute top-0 end-0 m-3">
                    <button type="button" class="btn btn-sm wishlist-btn-detail @(User.Identity?.IsAuthenticated == true && Model.IsInWishlist ? "btn-danger" : "btn-outline-danger")" data-product-id="@Model.Id" data-in-wishlist="@((User.Identity?.IsAuthenticated == true && Model.IsInWishlist).ToString().ToLower())">
                        <i class="bi @(User.Identity?.IsAuthenticated == true && Model.IsInWishlist ? "bi-heart-fill" : "bi-heart")"></i>
                    </button>
                </div>
                <div class="position-absolute top-0 start-0 m-3">
                    <span class="badge badge-verified"><i class="bi bi-geo-alt me-1"></i></span>
                </div>
                <div id="productGallery" class="carousel slide mb-3" data-bs-ride="carousel">
                    <div class="carousel-inner rounded-3 overflow-hidden">
                        @for (var i = 0; i < (Model.ImageUrls?.Count ?? 0); i++)
                        {
                            <div class="carousel-item @(i == 0 ? "active" : "")">
                                <img src="@Model.ImageUrls![i]" class="d-block w-100" style="aspect-ratio:1;object-fit:cover" alt="@Model.Name" onerror="this.src='/images/placeholder.svg'"/>
                            </div>
                        }
                        @if (Model.ImageUrls == null || Model.ImageUrls.Count == 0)
                        {
                            <div class="carousel-item active">
                                <img src="/images/placeholder.svg" class="d-block w-100" style="aspect-ratio:1;object-fit:cover" alt="@Model.Name"/>
                            </div>
                        }
                    </div>
                    @if (Model.ImageUrls != null && Model.ImageUrls.Count > 1)
                    {
                        <button class="carousel-control-prev" type="button" data-bs-target="#productGallery" data-bs-slide="prev"></button>
                        <button class="carousel-control-next" type="button" data-bs-target="#productGallery" data-bs-slide="next"></button>
                    }
                </div>
                @if (Model.ImageUrls != null && Model.ImageUrls.Count > 1)
                {
                    <div class="d-flex gap-2 overflow-auto">
                        @for (var i = 0; i < Model.ImageUrls.Count; i++)
                        {
                            <button type="button" class="flex-shrink-0 border rounded p-0 overflow-hidden @(i == 0 ? "border-primary border-2" : "border-secondary")" style="width:60px;height:60px;border-radius:10px;" data-bs-target="#productGallery" data-bs-slide-to="@i">
                                <img src="@Model.ImageUrls[i]" class="w-100 h-100 object-fit-cover" alt="" onerror="this.src='/images/placeholder.svg'" style="object-fit:cover"/>
                            </button>
                        }
                    </div>
                }
            </div>
            <div class="col-md-7 p-4">
                <h1 class="h3 mb-2">@Model.Name</h1>
                <p class="text-muted small mb-3">SKU: @Model.SKU</p>
                <div class="d-flex flex-wrap gap-2 mb-3">
                    @if (User.Identity?.IsAuthenticated == true)
                    {
                        <form class="js-add-to-cart-form d-inline" method="post" data-product-id="@Model.Id" data-quantity="1">
                            <button type="submit" class="btn btn-shopwala">Add to Cart</button>
                        </form>
                        <a asp-controller="Shop" asp-action="BuyNow" asp-route-id="@Model.Id" class="btn btn-secondary">Buy Now</a>
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#productChatModal"><i class="bi bi-chat-dots me-1"></i>Chat about this product</button>
                    }
                    else
                    {
                        <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path" class="btn btn-shopwala">Login to Add to Cart</a>
                        <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Url.Action("BuyNow", "Shop", new { id = Model.Id })" class="btn btn-secondary">Buy Now</a>
                        <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path" class="btn btn-outline-primary"><i class="bi bi-chat-dots me-1"></i>Login to Chat</a>
                    }
                </div>
                <p class="small text-muted mb-2"><i class="bi bi-truck me-1"></i>Shipping to: Karachi, Pakistan</p>
                <p class="mb-3">
                    <span class="product-price fs-4">Rs @displayPrice.ToString("N0")</span>
                    @if (Model.DiscountPrice.HasValue)
                    {
                        <span class="product-price-old ms-2">Rs @Model.SalePrice.ToString("N0")</span>
                        <span class="text-success small ms-1">(with membership discount)</span>
                    }
                </p>
                @{
                    var allSpecs = new List<(string Name, string Value)>();
                    if (Model.Attributes?.Count > 0)
                        allSpecs.AddRange(Model.Attributes.Select(a => (a.Name, a.Value)));
                    if (Model.Specifications?.Count > 0)
                        allSpecs.AddRange(Model.Specifications.Select(s => (s.Key, s.Value)));
                }
                @if (allSpecs.Any())
                {
                    <dl class="row small">
                        @foreach (var spec in allSpecs)
                        {
                            <dt class="col-sm-4 text-muted">@spec.Name</dt>
                            <dd class="col-sm-8">@spec.Value</dd>
                        }
                    </dl>
                }
                @if (!string.IsNullOrEmpty(Model.Description))
                {
                    <div class="mt-3">
                        <h6>Product Description</h6>
                        <p class="small text-muted">@Model.Description</p>
                    </div>
                }
                <div class="mt-3">
                    <h6>Customer Reviews</h6>
                    <div class="d-flex align-items-center gap-2 small">
                        <span class="text-warning"><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i></span>
                        <span class="text-muted">5.0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (User.Identity?.IsAuthenticated == true)
{
<div class="modal fade" id="productChatModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable" style="max-width: 480px;">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title"><i class="bi bi-chat-dots me-1"></i>Chat - @Model.Name</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" style="min-height: 320px;">
                <div id="chatMessages" class="p-3" style="max-height: 320px; overflow-y: auto;"></div>
                <div class="p-3 border-top">
                    <div class="input-group">
                        <input type="text" id="chatInput" class="form-control" placeholder="Type your message..." maxlength="500" />
                        <button type="button" id="chatSendBtn" class="btn btn-shopwala" title="Send"><i class="bi bi-send"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
}

@section Scripts {
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script>
$(function() {
    var g = typeof getGuestWishlist === 'function' ? getGuestWishlist() : [];
    var pid = parseInt('@Model.Id', 10);
    $('.wishlist-btn-detail').each(function() {
        if (g.indexOf(pid) >= 0) {
            this.dataset.inWishlist = 'true';
            this.classList.remove('btn-outline-danger'); this.classList.add('btn-danger');
            var icon = this.querySelector('i'); if (icon) { icon.classList.remove('bi-heart'); icon.classList.add('bi-heart-fill'); }
        }
    });
    $(document).on('click', '.wishlist-btn-detail', function(e) {
        e.preventDefault();
        var btn = this;
        var productId = btn.dataset.productId;
        var inWishlist = btn.dataset.inWishlist === 'true';
        if (typeof wishlistToggle === 'function') wishlistToggle(btn, productId, inWishlist);
    });

    var productId = @Model.Id;
    var chatThreadId = null;
    var chatConnection = null;
    var currentUserId = '@(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "")';

    function ensureChatConnection() {
        if (typeof signalR === 'undefined') return Promise.resolve(false);
        if (chatConnection && chatConnection.state === 1) return Promise.resolve(true);
        if (chatConnection && chatConnection.state === 0) return chatConnection.start().then(function() { return true; });
        chatConnection = new signalR.HubConnectionBuilder().withUrl('/hubs/productChat').withAutomaticReconnect().build();
        chatConnection.on('ReceiveMessage', function(msg) {
            if (msg.senderUserId && msg.senderUserId === currentUserId) return;
            appendMessage(msg.message, msg.isFromAdmin, msg.createdAt);
        });
        return chatConnection.start().then(function() { return true; });
    }

    function setChatReady(ready) {
        var input = document.getElementById('chatInput');
        var btn = document.getElementById('chatSendBtn');
        if (input) input.disabled = !ready;
        if (btn) btn.disabled = !ready;
    }

    function showChatError(msg) {
        $('#chatMessages').html('<div class="text-center text-muted py-4"><p class="mb-2">' + (msg || 'Could not load chat.') + '</p><button type="button" class="btn btn-sm btn-outline-primary" id="chatRetryBtn">Retry</button></div>');
        setChatReady(false);
        $(document).off('click.chatRetry').on('click.chatRetry', '#chatRetryBtn', function() { loadChatThread(); });
    }

    function loadChatThread() {
        var $messages = $('#chatMessages');
        $messages.html('<div class="text-center text-muted py-4"><span class="spinner-border spinner-border-sm me-2"></span>Loading conversation...</div>');
        setChatReady(false);
        fetch('/api/chat/thread/' + productId, { method: 'POST', credentials: 'include' })
            .then(function(r) {
                if (r.status === 401) {
                    showChatError('Please log in to chat.');
                    return null;
                }
                if (!r.ok) throw new Error('Failed to start chat');
                return r.json();
            })
            .then(function(d) {
                if (!d) return;
                chatThreadId = d.threadId || d.ThreadId;
                if (!chatThreadId) {
                    showChatError('Could not start chat. Please try again.');
                    return;
                }
                setChatReady(true);
                loadChatMessages();
                var inp = document.getElementById('chatInput');
                if (inp) { inp.focus(); }
                fetch('/api/chat/thread/' + chatThreadId + '/read', { method: 'POST', credentials: 'include' });
                ensureChatConnection().then(function() {
                    if (chatConnection && chatThreadId) chatConnection.invoke('JoinThread', chatThreadId);
                });
            })
            .catch(function() {
                showChatError('Could not load chat. Please try again.');
            });
    }

    $('#productChatModal').on('shown.bs.modal', function() {
        if (chatThreadId === null) {
            loadChatThread();
        } else {
            setChatReady(true);
            loadChatMessages();
            var inp = document.getElementById('chatInput');
            if (inp) { inp.focus(); }
            fetch('/api/chat/thread/' + chatThreadId + '/read', { method: 'POST', credentials: 'include' });
            ensureChatConnection().then(function() {
                if (chatConnection && chatThreadId) chatConnection.invoke('JoinThread', chatThreadId);
            });
        }
    });

    $('#productChatModal').on('hidden.bs.modal', function() {
        if (chatConnection && chatThreadId) {
            chatConnection.invoke('LeaveThread', chatThreadId).catch(function() {});
        }
    });

    function loadChatMessages() {
        if (!chatThreadId) return;
        fetch('/api/chat/thread/' + chatThreadId + '/messages', { credentials: 'include' })
            .then(function(r) { return r.json(); })
            .then(function(msgs) {
                $('#chatMessages').empty();
                msgs.forEach(function(m) {
                    appendMessage(m.message, m.isFromAdmin, m.createdAt);
                });
                $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
            });
    }

    function appendMessage(text, isFromAdmin, createdAt) {
        var dt = createdAt ? new Date(createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
        var html = '<div class="mb-2 ' + (isFromAdmin ? 'text-end' : '') + '"><div class="d-inline-block p-2 rounded-3 ' + (isFromAdmin ? 'bg-primary text-white' : 'bg-light') + '" style="max-width:85%"><small>' + $('<div/>').text(text).html() + '</small><br><small class="opacity-75">' + dt + '</small></div></div>';
        $('#chatMessages').append(html).scrollTop($('#chatMessages')[0].scrollHeight);
    }

    function doSend() {
        var txt = $('#chatInput').val().trim();
        if (!txt || !chatThreadId) return;
        $('#chatInput').val('');
        var isConnected = typeof signalR !== 'undefined' && chatConnection && chatConnection.state === 1;
        if (isConnected) {
            appendMessage(txt, false, new Date().toISOString());
            chatConnection.invoke('SendMessage', chatThreadId, txt);
        } else {
            fetch('/api/chat/thread/' + chatThreadId + '/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: txt }), credentials: 'include' })
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d && (!chatConnection || chatConnection.state !== 1)) appendMessage(d.message, d.isFromAdmin, d.createdAt);
                });
        }
    }
    $('#chatSendBtn').on('click', doSend);
    $('#chatInput').on('keypress', function(e) { if (e.which === 13) { e.preventDefault(); doSend(); } });
});
</script>
}
