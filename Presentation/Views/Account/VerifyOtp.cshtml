@model Presentation.ViewModels.Account.VerifyOtpViewModel
@{
    ViewData["Title"] = "Verify Account";
    Layout = "_Layout";
}

<div class="min-vh-100 d-flex align-items-center justify-content-center py-5">
    <div class="auth-modal col-11 col-md-5 col-lg-4">
        <div class="text-center mb-4">
            <a asp-controller="Home" asp-action="Index" class="text-decoration-none d-inline-flex align-items-center">
                <i class="bi bi-cart3 fs-3 me-2" style="color: var(--shopwala-primary);"></i>
                <span class="shopwala-brand fs-3">Shopwala</span>
            </a>
            <h2 class="fw-bold mt-3 mb-1">Verify Your Account</h2>
            <p class="text-muted small mb-1">Enter the 6-digit code sent to your email</p>
            <p class="small text-muted">email address: <strong>@Model.Email</strong></p>
        </div>
        <form asp-action="VerifyOtp" method="post" id="verifyForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Email" />
            <input type="hidden" name="returnUrl" value="@ViewData["ReturnUrl"]" />
            <div class="d-flex justify-content-center gap-2 mb-4">
                <input type="text" maxlength="1" class="otp-input" data-index="0" inputmode="numeric" autocomplete="one-time-code" />
                <input type="text" maxlength="1" class="otp-input" data-index="1" inputmode="numeric" />
                <input type="text" maxlength="1" class="otp-input" data-index="2" inputmode="numeric" />
                <input type="text" maxlength="1" class="otp-input" data-index="3" inputmode="numeric" />
                <input type="text" maxlength="1" class="otp-input" data-index="4" inputmode="numeric" />
                <input type="text" maxlength="1" class="otp-input" data-index="5" inputmode="numeric" />
            </div>
            <input type="hidden" asp-for="OTP" id="otpValue" />
            <div asp-validation-summary="ModelOnly" class="text-danger small text-center mb-2"></div>
            <button type="submit" class="btn btn-shopwala btn-lg w-100 py-3 rounded-3 mb-3">Verify Code</button>
            <div class="text-center mb-2">
                <span class="small text-muted">Resend Code</span>
                <span id="resendTimer" class="badge bg-light text-dark ms-2 border">60 seconds</span>
                <a href="#" id="resendLink" class="small ms-2 d-none">Resend</a>
            </div>
            <p class="text-center mb-0 small"><a asp-action="Register" class="text-primary">Change Email</a></p>
        </form>
    </div>
</div>

@section Scripts {
<partial name="_ValidationScriptsPartial" />
<script>
(function() {
    const inputs = document.querySelectorAll('.otp-input');
    const otpHidden = document.getElementById('otpValue');
    const form = document.getElementById('verifyForm');
    
    function updateOtp() {
        otpHidden.value = Array.from(inputs).map(i => i.value).join('');
    }
    
    inputs.forEach((input, i) => {
        input.addEventListener('input', function() {
            if (this.value.length === 1 && i < inputs.length - 1) inputs[i + 1].focus();
            updateOtp();
        });
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !this.value && i > 0) inputs[i - 1].focus();
        });
    });
    
    form.addEventListener('submit', function() { updateOtp(); });
    
    // Resend cooldown (60 sec)
    let seconds = 60;
    const timerEl = document.getElementById('resendTimer');
    const resendLink = document.getElementById('resendLink');
    
    const interval = setInterval(function() {
        seconds--;
        timerEl.textContent = seconds + ' seconds';
        if (seconds <= 0) {
            clearInterval(interval);
            timerEl.classList.add('d-none');
            resendLink.classList.remove('d-none');
        }
    }, 1000);
    
    resendLink.addEventListener('click', function(e) {
        e.preventDefault();
        var token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
        var fd = new FormData();
        fd.append('email', '@Model.Email');
        fd.append('__RequestVerificationToken', token);
        fetch('@Url.Action("ResendOtp")', { method: 'POST', body: fd, headers: { 'RequestVerificationToken': token } })
            .then(r => r.json()).then(d => { if(d.success) location.reload(); });
    });
})();
</script>
}
